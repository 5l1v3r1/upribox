---
- name: set hostname
  hostname: name="{{ hostname }}"
  
- name: configure hosts
  copy: src=hosts dest=/etc/hosts owner=root group=root mode=644

- name: configure locale
  shell: 'update-locale LC_ALL="en_GB.UTF-8" LANG="en_GB.UTF-8"'
  
- name: install sudo, raspi-config and wifi firmware
  apt: name={{ item }} state=present force=yes update_cache=yes cache_valid_time="{{ apt_cache_time }}"
  with_items:
    - sudo 
    - raspi-config
    - firmware-atheros
    - firmware-ralink
  
- name: create sudo group
  group: name="{{ sudo_group }}" state=present
  
- name: create remote user
  user: name="{{ remote_user }}" shell="{{ remote_user_login_shell }}" groups="{{sudo_group}}" append=yes
  
- name: configure sudoers
  template: src=sudoers.j2 dest=/etc/sudoers validate='visudo -cf %s'
  
- name: add authorized key
  authorized_key: user="{{ remote_user }}" key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
  when: pull_deployment is not defined

- name: disable root account
  shell: passwd -dl root

- name: expand disk space
  shell: raspi-config --expand-rootfs

- name: rebooting raspberry Pi ...
  command: shutdown -r now "ansible reboot"
  async: 0
  poll: 0
  ignore_errors: true

- name: waiting for the Pi to come back
  local_action: wait_for host={{ inventory_hostname }} state=started delay=30 timeout=300
  sudo: false
